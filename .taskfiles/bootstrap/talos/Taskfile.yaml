---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  genmachine:
    desc: Bootstrap genmachine cluster
    vars:
      cluster: genmachine
      TALOS_DIR: '{{.TALOS_ROOT}}/{{.cluster}}'
    env:
      TALOS_DIR: '{{.TALOS_DIR}}'
    cmds:
      - task: :talos:bootstrap
        vars:
          cluster: genmachine
      # - task: save-config
      #   vars:
      #     cluster: main
      # - task: merge-configs
      # - task: deploy
      #   vars:
      #     cluster: main

  staging:
    desc: Bootstrap staging cluster
    cmds:
      - task: :proxmox:reset-staging
      - task: :talos:bootstrap
        vars:
          cluster: staging
      - task: :proxmox:unmount-staging-cdrom
      - task: save-config
        vars:
          cluster: staging
      - task: merge-configs
      - task: deploy
        vars:
          cluster: staging

  deploy:
    desc: Bootstrap [cluster={{.cluster}}]
    requires:
      vars:
        - cluster
    preconditions:
      - op user get --me
      - talosctl --context {{.cluster}} config info
      - test -f "${KUBECONFIG}"
      - test -f "${TALOSCONFIG}"
      - test -f {{.KUBERNETES_DIR}}/bootstrap/apps/resources/prepare.sh
      - test -f {{.KUBERNETES_DIR}}/bootstrap/apps/helmfile.yaml
    env:
      KUBERNETES_DIR: '{{.KUBERNETES_DIR}}'
      KUBECONFIG: '{{.KUBERNETES_DIR}}/kubeconfig'
      TALOSCONFIG: '{{.KUBERNETES_DIR}}/talosconfig'
    vars:
      KUBERNETES_DIR: '{{.KUBERNETES_ROOT}}/{{.cluster}}'
    cmds:
      - bash {{.KUBERNETES_DIR}}/bootstrap/apps/resources/prepare.sh
      - helmfile --quiet --file {{.KUBERNETES_DIR}}/bootstrap/apps/helmfile.yaml apply --skip-diff-on-install --suppress-diff

  save-config:
    desc: Save kubeconfig and talosconfig to HC Vault
    requires:
      vars:
        - cluster
    preconditions:
      - test -f "{{.TALOS_DIR}}/kubeconfig"
      - test -f "{{.TALOS_DIR}}/talosconfig"
    vars:
      TALOS_DIR: '{{.TALOS_ROOT}}/{{.cluster}}'
    cmds:
      - |
        vault kv put -tls-skip-verify -address={{.VAULT_ENDPOINT}} admin/kubernetes/{{.cluster}}/talos \
                      talosconfig=@{{.TALOS_DIR}}/talosconfig \
                      kubeconfig=@{{.TALOS_DIR}}/kubeconfig \
                      talosconfigb64=$(base64 -w0 < {{.TALOS_DIR}}/talosconfig) \
                      kubeconfigb64=$(base64 -w0 < {{.TALOS_DIR}}/kubeconfig)

  fetch-config:
    desc: Fetch kubeconfig and talosconfig from HC Vault
    requires:
      vars:
        - cluster
    vars:
      TALOS_DIR: '{{.TALOS_ROOT}}/{{.cluster}}'
    cmds:
      - vault kv get -field=talosconfigb64 -tls-skip-verify -address={{.VAULT_ENDPOINT}} admin/kubernetes/{{.cluster}}/talos | base64 -d > {{.TALOS_DIR}}/talosconfig
      - vault kv get -field=kubeconfigb64 -tls-skip-verify -address={{.VAULT_ENDPOINT}} admin/kubernetes/{{.cluster}}/talos | base64 -d > {{.TALOS_DIR}}/kubeconfig

  merge-configs:
    desc: Merge all configurations into ~/.kube and ~/.talos
    preconditions:
      - test -f "{{.KUBERNETES_ROOT}}/main/kubeconfig"
      - test -f "{{.KUBERNETES_ROOT}}/main/talosconfig"
      - test -f "{{.KUBERNETES_ROOT}}/staging/kubeconfig"
      - test -f "{{.KUBERNETES_ROOT}}/staging/talosconfig"
    cmds:
      - KUBECONFIG="{{.KUBERNETES_ROOT}}/main/kubeconfig:{{.KUBERNETES_ROOT}}/staging/kubeconfig" kubectl config view --flatten > $HOME/.kube/config
      - cp {{.KUBERNETES_ROOT}}/main/talosconfig $HOME/.talos/config
      - talosctl --talosconfig $HOME/.talos/config config merge {{.KUBERNETES_ROOT}}/staging/talosconfig
      - chmod og-rwx $HOME/.kube/config
      - chmod og-rwx $HOME/.talos/config
      - kubectl --kubeconfig=$HOME/.kube/config config use-context main
      - talosctl --talosconfig $HOME/.talos/config config context main
